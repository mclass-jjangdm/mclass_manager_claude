{% extends 'students/base_students.html' %}

{% block student_content %}

<div class="max-w-4xl mx-auto">
    <div class="bg-white rounded-lg shadow p-6">
        <div class="mb-6">
            <h1 class="text-2xl font-bold text-gray-800">성적 일괄 업로드</h1>
            <p class="text-gray-600 mt-2">학생: <span class="font-semibold">{{ student.name }}</span></p>
        </div>

        <!-- 안내 메시지 -->
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
            <h3 class="text-blue-800 font-semibold mb-2">파일 형식 안내</h3>
            <ul class="text-blue-700 text-sm space-y-1">
                <li>CSV 또는 Excel(.xlsx, .xls) 파일을 업로드할 수 있습니다.</li>
                <li>첫 번째 행은 반드시 헤더(컬럼명)여야 합니다.</li>
                <li>과목은 과목코드 또는 과목명으로 찾습니다.</li>
                <li>템플릿을 다운로드하여 형식을 확인하세요.</li>
            </ul>
        </div>

        <!-- 템플릿 다운로드 버튼 -->
        <div class="flex gap-4 mb-6">
            <a href="{% url 'grades:download_grade_template' 'internal' %}"
               class="flex items-center px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg text-sm font-medium transition-colors">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                내신 템플릿 다운로드
            </a>
            <a href="{% url 'grades:download_grade_template' 'mock' %}"
               class="flex items-center px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg text-sm font-medium transition-colors">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                모의고사 템플릿 다운로드
            </a>
        </div>

        <!-- 필드 설명 -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <!-- 내신 필드 설명 -->
            <div class="bg-gray-50 rounded-lg p-4">
                <h4 class="font-semibold text-gray-700 mb-2">내신 성적 필수 필드</h4>
                <ul class="text-sm text-gray-600 space-y-1">
                    <li><code class="bg-gray-200 px-1 rounded">학년</code> - 1, 2, 3</li>
                    <li><code class="bg-gray-200 px-1 rounded">학기</code> - 1 또는 2</li>
                    <li><code class="bg-gray-200 px-1 rounded">과목코드</code> 또는 <code class="bg-gray-200 px-1 rounded">과목명</code></li>
                    <li><code class="bg-gray-200 px-1 rounded">단위</code> - 수업 단위수</li>
                    <li><code class="bg-gray-200 px-1 rounded">원점수</code></li>
                    <li><code class="bg-gray-200 px-1 rounded">과목평균</code> (또는 <code class="bg-gray-200 px-1 rounded">평균</code>)</li>
                    <li><code class="bg-gray-200 px-1 rounded">표준편차</code></li>
                    <li><code class="bg-gray-200 px-1 rounded">등급</code> - 1~9</li>
                    <li><code class="bg-gray-200 px-1 rounded">진로선택</code> - 선택사항 (진로선택, 1, yes, o, ○ 등)</li>
                </ul>
            </div>

            <!-- 모의고사 필드 설명 -->
            <div class="bg-gray-50 rounded-lg p-4">
                <h4 class="font-semibold text-gray-700 mb-2">모의고사 성적 필수 필드</h4>
                <ul class="text-sm text-gray-600 space-y-1">
                    <li><code class="bg-gray-200 px-1 rounded">학년</code> - 1, 2, 3</li>
                    <li><code class="bg-gray-200 px-1 rounded">시험연도</code> (또는 <code class="bg-gray-200 px-1 rounded">연도</code>)</li>
                    <li><code class="bg-gray-200 px-1 rounded">시험월</code> (또는 <code class="bg-gray-200 px-1 rounded">월</code>) - 1~12</li>
                    <li><code class="bg-gray-200 px-1 rounded">시험명</code> (또는 <code class="bg-gray-200 px-1 rounded">모의고사명</code>)</li>
                    <li><code class="bg-gray-200 px-1 rounded">과목코드</code> 또는 <code class="bg-gray-200 px-1 rounded">과목명</code></li>
                    <li><code class="bg-gray-200 px-1 rounded">원점수</code></li>
                    <li><code class="bg-gray-200 px-1 rounded">과목평균</code> (또는 <code class="bg-gray-200 px-1 rounded">평균</code>)</li>
                    <li><code class="bg-gray-200 px-1 rounded">표준편차</code></li>
                    <li><code class="bg-gray-200 px-1 rounded">등급</code> - 1~9</li>
                    <li><code class="bg-gray-200 px-1 rounded">백분위</code></li>
                </ul>
            </div>
        </div>

        <!-- 업로드 폼 -->
        <form method="post" enctype="multipart/form-data" class="space-y-6">
            {% csrf_token %}

            <!-- 성적 유형 선택 -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-3">성적 유형 *</label>
                <div class="flex gap-6">
                    {% for radio in form.grade_type %}
                    <label class="inline-flex items-center cursor-pointer">
                        {{ radio.tag }}
                        <span class="ml-2 text-gray-700">{{ radio.choice_label }}</span>
                    </label>
                    {% endfor %}
                </div>
                {% if form.grade_type.errors %}
                    <p class="mt-1 text-sm text-red-600">{{ form.grade_type.errors.0 }}</p>
                {% endif %}
            </div>

            <!-- 파일 선택 -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">파일 선택 *</label>
                <div id="drop-zone" class="drop-zone mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-lg hover:border-indigo-400 transition-colors cursor-pointer">
                    <div class="space-y-1 text-center">
                        <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                            <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                        <div class="flex text-sm text-gray-600">
                            <label for="id_file" class="relative cursor-pointer bg-white rounded-md font-medium text-indigo-600 hover:text-indigo-500">
                                <span>파일 선택</span>
                                {{ form.file }}
                            </label>
                            <p class="pl-1">또는 드래그 앤 드롭</p>
                        </div>
                        <p class="text-xs text-gray-500">CSV, XLSX, XLS 파일 지원</p>
                    </div>
                </div>
                <p id="file-name" class="mt-2 text-sm text-indigo-600 font-medium"></p>
                {% if form.file.errors %}
                    <p class="mt-1 text-sm text-red-600">{{ form.file.errors.0 }}</p>
                {% endif %}
            </div>

            <!-- 버튼 -->
            <div class="flex justify-end space-x-3 pt-4 border-t">
                <a href="{% url 'students:student_detail' student.pk %}"
                   class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50">
                    취소
                </a>
                <button type="submit"
                        class="px-6 py-2 bg-indigo-500 hover:bg-indigo-600 text-white rounded-md text-sm font-medium">
                    업로드
                </button>
            </div>
        </form>
    </div>
</div>

<style>
    input[type="file"] {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
    }

    input[type="radio"] {
        width: 1rem;
        height: 1rem;
        color: #6366f1;
    }

    .drop-zone.drag-over {
        border-color: #6366f1;
        background-color: #eef2ff;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const fileInput = document.getElementById('id_file');
    const fileNameDisplay = document.getElementById('file-name');
    const dropZone = document.getElementById('drop-zone');

    if (fileInput) {
        fileInput.addEventListener('change', function() {
            if (this.files && this.files.length > 0) {
                fileNameDisplay.textContent = '선택된 파일: ' + this.files[0].name;
            } else {
                fileNameDisplay.textContent = '';
            }
        });
    }

    if (dropZone) {
        // 드래그 오버 시 스타일 변경
        dropZone.addEventListener('dragover', function(e) {
            e.preventDefault();
            e.stopPropagation();
            this.classList.add('drag-over');
        });

        dropZone.addEventListener('dragenter', function(e) {
            e.preventDefault();
            e.stopPropagation();
            this.classList.add('drag-over');
        });

        dropZone.addEventListener('dragleave', function(e) {
            e.preventDefault();
            e.stopPropagation();
            this.classList.remove('drag-over');
        });

        // 드롭 시 파일 처리
        dropZone.addEventListener('drop', function(e) {
            e.preventDefault();
            e.stopPropagation();
            this.classList.remove('drag-over');

            const files = e.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0];
                const fileName = file.name.toLowerCase();

                // 파일 확장자 검증
                if (fileName.endsWith('.csv') || fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
                    fileInput.files = files;
                    fileNameDisplay.textContent = '선택된 파일: ' + file.name;
                } else {
                    alert('CSV, XLSX, XLS 파일만 업로드할 수 있습니다.');
                }
            }
        });
    }
});
</script>

{% endblock %}
