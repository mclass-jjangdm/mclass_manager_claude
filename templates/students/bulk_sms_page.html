{% extends 'students/base_students.html' %}

{% block title %}일괄 문자 발송{% endblock %}

{% block student_content %}
<div class="mb-6">
    <div class="flex items-center justify-between">
        <h1 class="text-3xl font-bold text-gray-800">일괄 문자 발송</h1>
        <a href="{% url 'students:student_list' %}"
           class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg font-medium transition-colors">
            ← 학생 목록으로
        </a>
    </div>
</div>

<form method="post" id="sms-form">
    {% csrf_token %}

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- 왼쪽: 학생 선택 영역 (2/3) -->
        <div class="lg:col-span-2">
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold text-gray-900">발송 대상 선택</h2>
                    <div class="flex items-center space-x-2">
                        <button type="button" onclick="selectAll()"
                                class="text-sm text-indigo-600 hover:text-indigo-800 font-medium">
                            전체 선택
                        </button>
                        <span class="text-gray-400">|</span>
                        <button type="button" onclick="deselectAll()"
                                class="text-sm text-gray-600 hover:text-gray-800 font-medium">
                            선택 해제
                        </button>
                    </div>
                </div>

                <div class="mb-4 p-3 bg-blue-50 border-l-4 border-blue-500 rounded">
                    <p class="text-sm text-blue-800">
                        <span id="selected-count" class="font-bold">0</span>명이 선택되었습니다.
                    </p>
                </div>

                <!-- 학년별 학생 목록 -->
                {% if grouped_students %}
                    {% for grade, students in grouped_students.items %}
                    <div class="mb-6">
                        <div class="flex items-center mb-3 pb-2 border-b border-gray-200">
                            <input type="checkbox"
                                   id="grade-{{ grade }}"
                                   class="grade-checkbox form-checkbox h-4 w-4 text-indigo-600 mr-2"
                                   onchange="toggleGrade('{{ grade }}')">
                            <label for="grade-{{ grade }}" class="text-lg font-semibold text-gray-700 cursor-pointer">
                                {{ grade }}
                            </label>
                            <span class="ml-2 px-2 py-1 bg-gray-100 text-gray-600 text-xs font-medium rounded-full">
                                {{ students|length }}명
                            </span>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-2 ml-6">
                            {% for student in students %}
                            <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                <input type="checkbox"
                                       name="student_ids"
                                       value="{{ student.pk }}"
                                       class="student-checkbox grade-{{ grade }}-student form-checkbox h-4 w-4 text-indigo-600"
                                       onchange="updateCount()"
                                       data-grade="{{ grade }}">
                                <div class="ml-3 flex-1">
                                    <div class="text-sm font-medium text-gray-900">{{ student.name }}</div>
                                    <div class="text-xs text-gray-500">
                                        {% if student.phone_number %}학생: {{ student.phone_number }}{% endif %}
                                        {% if student.parent_phone %} | 부모: {{ student.parent_phone }}{% endif %}
                                    </div>
                                </div>
                            </label>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                <div class="text-center py-8 text-gray-500">
                    재원 중인 학생이 없습니다.
                </div>
                {% endif %}
            </div>
        </div>

        <!-- 오른쪽: 메시지 작성 영역 (1/3) -->
        <div class="lg:col-span-1">
            <div class="bg-white rounded-lg shadow p-6 sticky top-6">
                <h2 class="text-xl font-bold text-gray-900 mb-4">메시지 작성</h2>

                <!-- 발송 대상 선택 -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">발송 대상</label>
                    <div class="space-y-2">
                        <label class="flex items-center">
                            <input type="radio" name="target" value="student" class="form-radio h-4 w-4 text-indigo-600" checked>
                            <span class="ml-2 text-sm text-gray-700">학생에게만</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="target" value="parent" class="form-radio h-4 w-4 text-indigo-600">
                            <span class="ml-2 text-sm text-gray-700">학부모에게만</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="target" value="both" class="form-radio h-4 w-4 text-indigo-600">
                            <span class="ml-2 text-sm text-gray-700">학생 + 학부모</span>
                        </label>
                    </div>
                </div>

                <!-- 메시지 입력 -->
                <div class="mb-4">
                    <label for="message" class="block text-sm font-medium text-gray-700 mb-2">메시지 내용</label>
                    <textarea
                        id="message"
                        name="message"
                        rows="8"
                        required
                        maxlength="2000"
                        class="form-textarea w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"
                        placeholder="발송할 메시지를 입력하세요..."
                        onkeyup="updateCharCount()"></textarea>
                    <div class="mt-1 text-xs text-gray-500 text-right">
                        <span id="char-count">0</span> / 2000자
                    </div>
                </div>

                <!-- 발송 버튼 -->
                <button
                    type="submit"
                    class="w-full bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-lg font-medium transition-colors">
                    문자 발송
                </button>

                <!-- 안내 메시지 -->
                <div class="mt-4 p-3 bg-yellow-50 border-l-4 border-yellow-400 rounded">
                    <p class="text-xs text-yellow-800">
                        <strong>주의:</strong> 발송 전 대상과 메시지를 꼭 확인하세요.
                    </p>
                </div>
            </div>
        </div>
    </div>
</form>

<script>
// 선택된 학생 수 업데이트
function updateCount() {
    const checked = document.querySelectorAll('.student-checkbox:checked').length;
    document.getElementById('selected-count').textContent = checked;

    // 학년 체크박스 상태 업데이트
    const grades = new Set();
    document.querySelectorAll('.student-checkbox').forEach(cb => {
        grades.add(cb.dataset.grade);
    });

    grades.forEach(grade => {
        const gradeCheckbox = document.getElementById(`grade-${grade}`);
        const gradeStudents = document.querySelectorAll(`.grade-${grade}-student`);
        const checkedGradeStudents = document.querySelectorAll(`.grade-${grade}-student:checked`);

        if (checkedGradeStudents.length === 0) {
            gradeCheckbox.checked = false;
            gradeCheckbox.indeterminate = false;
        } else if (checkedGradeStudents.length === gradeStudents.length) {
            gradeCheckbox.checked = true;
            gradeCheckbox.indeterminate = false;
        } else {
            gradeCheckbox.checked = false;
            gradeCheckbox.indeterminate = true;
        }
    });
}

// 전체 선택
function selectAll() {
    document.querySelectorAll('.student-checkbox').forEach(cb => cb.checked = true);
    document.querySelectorAll('.grade-checkbox').forEach(cb => cb.checked = true);
    updateCount();
}

// 전체 해제
function deselectAll() {
    document.querySelectorAll('.student-checkbox').forEach(cb => cb.checked = false);
    document.querySelectorAll('.grade-checkbox').forEach(cb => cb.checked = false);
    updateCount();
}

// 학년별 토글
function toggleGrade(grade) {
    const gradeCheckbox = document.getElementById(`grade-${grade}`);
    const isChecked = gradeCheckbox.checked;
    document.querySelectorAll(`.grade-${grade}-student`).forEach(cb => {
        cb.checked = isChecked;
    });
    updateCount();
}

// 글자 수 카운트
function updateCharCount() {
    const message = document.getElementById('message').value;
    document.getElementById('char-count').textContent = message.length;
}

// 폼 제출 전 확인
document.getElementById('sms-form').addEventListener('submit', function(e) {
    const checked = document.querySelectorAll('.student-checkbox:checked').length;
    const message = document.getElementById('message').value.trim();
    const target = document.querySelector('input[name="target"]:checked').value;

    if (checked === 0) {
        e.preventDefault();
        alert('발송 대상 학생을 선택해주세요.');
        return false;
    }

    if (!message) {
        e.preventDefault();
        alert('메시지를 입력해주세요.');
        return false;
    }

    let targetText = '';
    if (target === 'student') targetText = '학생';
    else if (target === 'parent') targetText = '학부모';
    else targetText = '학생 + 학부모';

    const totalRecipients = target === 'both' ? checked * 2 : checked;

    if (!confirm(`${checked}명의 ${targetText}에게 문자를 발송하시겠습니까?\n(총 ${totalRecipients}건 발송)`)) {
        e.preventDefault();
        return false;
    }
});
</script>

{% endblock %}
