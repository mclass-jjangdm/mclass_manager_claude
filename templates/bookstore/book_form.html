{% extends "base.html" %}

{% block content %}
<div style="max-width: 700px; margin: 0 auto;">

    <h2 style="text-align: center; margin-bottom: 25px; color: #111827;">
        {{ title }}
    </h2>

    <div class="card">
        <form method="POST">
            {% csrf_token %}

            <div class="form-group">
                <label for="id_created_at" class="form-label"> 등록일 (입고일)</label>
                {{ form.created_at }}
            </div>

            <div class="form-group">
                <label for="id_isbn" class="form-label">바코드 (ISBN)</label>
                {{ form.isbn }}
                <p style="font-size: 0.85rem; color: #6b7280; margin-top: 5px;">
                    * 바코드 리더기로 스캔하거나 수동 입력 후 Enter/Tab을 누르세요.
                </p>
            </div>

            <div class="form-group">
                <label for="id_title" class="form-label">교재명</label>
                {{ form.title }}
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                <div>
                    <label for="id_author" class="form-label">저자</label>
                    {{ form.author }}
                </div>
                <div>
                    <label for="id_publisher" class="form-label">출판사</label>
                    {{ form.publisher }}
                </div>
            </div>

            <div class="form-group" style="background-color: #F9FAFB; padding: 15px; border-radius: 8px; border: 1px solid #E5E7EB;">
                <label for="id_supplier" class="form-label" style="color: #4338CA;">
                    구매처 (공급사)
                </label>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <div style="flex-grow: 1;">
                        {{ form.supplier }}
                    </div>
                    <a href="#" id="add-supplier-btn" class="btn btn-outline"
                       style="white-space: nowrap; padding: 10px 15px; font-size: 0.9rem;">
                        새 구매처
                    </a>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                <div>
                    <label for="id_original_price" class="form-label">정가</label>
                    {{ form.original_price }}
                </div>
                <div>
                    <label for="id_cost_price" class="form-label">입고가 (원가)</label>
                    {{ form.cost_price }}
                </div>
                <div>
                    <label for="id_price" class="form-label">판매가</label>
                    {{ form.price }}
                </div>
            </div>

            <div class="form-group">
                <label for="id_stock" class="form-label">초기 입고 수량</label>
                {{ form.stock }}
            </div>

            <div class="form-group">
                <label for="id_memo" class="form-label">비고</label>
                {{ form.memo }}
            </div>

            <div style="margin-top: 30px; display: flex; gap: 10px;">
                <button type="submit" class="btn btn-primary" style="flex: 1; padding: 12px; font-size: 1rem;">
                    저장하기
                </button>
                <a href="{% url 'bookstore:book_list' %}" class="btn btn-outline" style="padding: 12px; font-size: 1rem;">
                    취소
                </a>
            </div>
        </form>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 모든 입력 필드에 모던 스타일 클래스 강제 적용
        document.querySelectorAll('input, select, textarea').forEach(el => {
            el.classList.add('form-control'); // style.css에 정의된 예쁜 스타일
            // 체크박스 등 예외처리가 필요하면 여기에 추가
        });

        const isbnInput = document.getElementById('id_isbn');

        // 1. 바코드 스캔 처리 및 API 호출 로직
        if (isbnInput) {
            isbnInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' || e.key === 'Tab') {
                    // Enter키 제출 방지
                    if(e.key === 'Enter') e.preventDefault();

                    let rawValue = isbnInput.value.trim().replace(/-/g, '').toUpperCase();

                    // ISBN 10자리 -> 13자리 변환 로직
                    if (rawValue.length === 10) {
                        const core = rawValue.substring(0, 9);
                        const prefix = "978";
                        const tempIsbn = prefix + core;
                        let sum = 0;
                        for (let i = 0; i < 12; i++) {
                            sum += parseInt(tempIsbn[i]) * (i % 2 === 0 ? 1 : 3);
                        }
                        let checkDigit = (10 - (sum % 10)) % 10;
                        if (checkDigit === 10) checkDigit = 0;
                        isbnInput.value = tempIsbn + checkDigit;
                    } else {
                        isbnInput.value = rawValue;
                    }

                    const finalIsbn = isbnInput.value;
                    if (finalIsbn !== "") {
                        fetchBookInfo(finalIsbn);
                    }
                }
            });
        }

        function fetchBookInfo(isbn) {
            // 커서 모양 변경으로 로딩 표시
            document.body.style.cursor = 'wait';

            // API 호출
            fetch(`/bookstore/api/search/?isbn=${isbn}`)
                .then(response => response.json())
                .then(data => {
                    document.body.style.cursor = 'default';
                    if (!data.error) {
                        const titleInput = document.getElementById('id_title');
                        const authorInput = document.getElementById('id_author');
                        const publisherInput = document.getElementById('id_publisher');
                        const originalPriceInput = document.getElementById('id_original_price');

                        if (titleInput && !titleInput.value) titleInput.value = data.title;
                        if (authorInput && !authorInput.value) authorInput.value = data.author;
                        if (publisherInput && !publisherInput.value) publisherInput.value = data.publisher;
                        if (originalPriceInput && data.price && data.price !== '0' && !originalPriceInput.value) {
                            originalPriceInput.value = data.price;
                        }
                        // 제목으로 포커스 이동
                        if (titleInput) titleInput.focus();
                    } else {
                        // 에러여도 제목으로 이동
                        const titleInput = document.getElementById('id_title');
                        if (titleInput) titleInput.focus();
                    }
                })
                .catch(error => {
                    document.body.style.cursor = 'default';
                    console.error('API Error:', error);
                    const titleInput = document.getElementById('id_title');
                    if (titleInput) titleInput.focus();
                });
        }

        // 2. [핵심] 구매처 등록 이동 시 데이터 보존 로직
        const addSupplierBtn = document.getElementById('add-supplier-btn');
        if (addSupplierBtn) {
            addSupplierBtn.addEventListener('click', function(e) {
                e.preventDefault();

                const params = new URLSearchParams();
                // 저장할 필드 목록
                const fields = ['created_at', 'isbn', 'title', 'author', 'publisher', 'original_price', 'cost_price', 'price', 'stock', 'memo'];

                fields.forEach(field => {
                    const element = document.getElementById('id_' + field);
                    if (element && element.value) {
                        params.append(field, element.value);
                    }
                });

                // 현재 입력값들을 쿼리 스트링으로 만듦
                const returnUrl = "{% url 'bookstore:book_create' %}?" + params.toString();

                // next 파라미터에 담아서 이동
                const targetUrl = "{% url 'bookstore:supplier_create' %}?next=" + encodeURIComponent(returnUrl);
                window.location.href = targetUrl;
            });
        }
    });
</script>
{% endblock %}