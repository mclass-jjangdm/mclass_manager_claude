{% extends "bookstore/base_bookstore.html" %}

{% block bookstore_content %}
<div class="max-w-3xl mx-auto">
    <h2 class="text-2xl font-bold text-gray-800 text-center mb-6">
        {{ title }}
    </h2>

    <div class="content-card">
        <form method="POST" class="space-y-6">
            {% csrf_token %}

            <!-- 교과 선택 (체크박스) -->
            <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                <label class="form-label mb-3 block">교과 선택</label>
                <div class="flex flex-wrap gap-3" id="category-checkboxes">
                    {% for category in categories %}
                    <label class="inline-flex items-center cursor-pointer">
                        <input type="checkbox"
                               name="category_filter"
                               value="{{ category }}"
                               class="form-checkbox h-4 w-4 text-indigo-600 category-checkbox"
                               {% if category == '수학' or selected_category == category %}checked{% endif %}
                               onchange="filterSubjects()">
                        <span class="ml-2 text-sm text-gray-700">{{ category }}</span>
                    </label>
                    {% endfor %}
                </div>
            </div>

            <!-- 과목 선택 (필터링된 드롭다운) -->
            <div>
                <label for="id_subject" class="form-label">과목</label>
                <select name="subject" id="id_subject" class="form-input">
                    <option value="">---------</option>
                </select>
                <p class="text-sm text-gray-500 mt-1">* 위에서 교과를 선택하면 해당 과목만 표시됩니다.</p>
            </div>

            <div>
                <label for="id_created_at" class="form-label">등록일 (입고일)</label>
                {{ form.created_at }}
            </div>

            <div>
                <label for="id_isbn" class="form-label">바코드 (ISBN)</label>
                {{ form.isbn }}
                <p class="text-sm text-gray-500 mt-1">
                    * 바코드 리더기로 스캔하거나 수동 입력 후 Enter/Tab을 누르세요.
                </p>
            </div>

            <div>
                <label for="id_title" class="form-label">교재명</label>
                {{ form.title }}
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label for="id_author" class="form-label">저자</label>
                    {{ form.author }}
                </div>
                <div>
                    <label for="id_publisher" class="form-label">출판사</label>
                    {{ form.publisher }}
                </div>
            </div>

            <div class="bg-indigo-50 p-4 rounded-lg border border-indigo-100">
                <label for="id_supplier" class="form-label text-indigo-800">
                    구매처 (공급사)
                </label>
                <div class="flex gap-3 items-center">
                    <div class="flex-1">
                        {{ form.supplier }}
                    </div>
                    <a href="#" id="add-supplier-btn"
                       class="bg-white hover:bg-gray-50 border border-gray-300 text-gray-700 px-4 py-2 rounded-lg font-medium transition-colors whitespace-nowrap">
                        새 구매처
                    </a>
                </div>
            </div>

            <div class="grid grid-cols-3 gap-4">
                <div>
                    <label for="id_original_price" class="form-label">정가</label>
                    {{ form.original_price }}
                </div>
                <div>
                    <label for="id_cost_price" class="form-label">입고가 (원가)</label>
                    {{ form.cost_price }}
                </div>
                <div>
                    <label for="id_price" class="form-label">판매가</label>
                    {{ form.price }}
                </div>
            </div>

            <div>
                <label for="id_stock" class="form-label">초기 입고 수량</label>
                {{ form.stock }}
            </div>

            <div>
                <label for="id_memo" class="form-label">비고</label>
                {{ form.memo }}
            </div>

            <div class="flex gap-3 pt-4">
                <button type="submit"
                        class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-lg font-medium text-base transition-colors">
                    저장하기
                </button>
                <a href="{% url 'bookstore:book_list' %}"
                   class="bg-white hover:bg-gray-50 border border-gray-300 text-gray-700 px-6 py-3 rounded-lg font-medium text-base transition-colors">
                    취소
                </a>
            </div>
        </form>
    </div>
</div>

<script>
    // 과목 데이터 (서버에서 전달)
    const groupedSubjects = {{ grouped_subjects_json|safe }};
    const initialSubjectId = {{ form.subject.value|default:"null" }};

    function filterSubjects() {
        const subjectSelect = document.getElementById('id_subject');
        const checkboxes = document.querySelectorAll('.category-checkbox:checked');
        const selectedCategories = Array.from(checkboxes).map(cb => cb.value);

        // 현재 선택된 값 저장
        const currentValue = subjectSelect.value;

        // 드롭다운 초기화
        subjectSelect.innerHTML = '<option value="">---------</option>';

        // 선택된 카테고리의 과목들 추가
        selectedCategories.forEach(category => {
            if (groupedSubjects[category]) {
                groupedSubjects[category].forEach(subject => {
                    const option = document.createElement('option');
                    option.value = subject.id;
                    option.textContent = `[${subject.code}] ${subject.name}`;
                    subjectSelect.appendChild(option);
                });
            }
        });

        // 이전에 선택된 값이 있으면 복원
        if (currentValue) {
            subjectSelect.value = currentValue;
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        // 페이지 로드 시 과목 필터링 실행
        filterSubjects();

        // 초기 선택값 설정
        if (initialSubjectId) {
            document.getElementById('id_subject').value = initialSubjectId;
        }

        // 모든 입력 필드에 form-input 클래스 적용
        document.querySelectorAll('input, select, textarea').forEach(el => {
            if (!el.classList.contains('form-checkbox') && !el.classList.contains('form-radio')) {
                el.classList.add('form-input');
            }
        });

        const isbnInput = document.getElementById('id_isbn');
        let lastFetchedIsbn = '';  // 중복 호출 방지용

        // ISBN 처리 및 API 호출 함수
        function processIsbnAndFetch() {
            let rawValue = isbnInput.value.trim().replace(/-/g, '').toUpperCase();

            // 빈 값이면 무시
            if (!rawValue) return;

            // ISBN 10자리 -> 13자리 변환 로직
            if (rawValue.length === 10) {
                const core = rawValue.substring(0, 9);
                const prefix = "978";
                const tempIsbn = prefix + core;
                let sum = 0;
                for (let i = 0; i < 12; i++) {
                    sum += parseInt(tempIsbn[i]) * (i % 2 === 0 ? 1 : 3);
                }
                let checkDigit = (10 - (sum % 10)) % 10;
                if (checkDigit === 10) checkDigit = 0;
                isbnInput.value = tempIsbn + checkDigit;
            } else {
                isbnInput.value = rawValue;
            }

            const finalIsbn = isbnInput.value;

            // 이미 조회한 ISBN이면 중복 호출 방지
            if (finalIsbn && finalIsbn !== lastFetchedIsbn) {
                lastFetchedIsbn = finalIsbn;
                console.log('ISBN 조회 시작:', finalIsbn);  // 디버깅용
                fetchBookInfo(finalIsbn);
            }
        }

        // 1. 바코드 스캔 처리 및 API 호출 로직
        if (isbnInput) {
            // Enter/Tab 키 입력 시
            isbnInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' || e.key === 'Tab') {
                    if(e.key === 'Enter') e.preventDefault();
                    processIsbnAndFetch();
                }
            });

            // 포커스 아웃 시 (마우스로 다른 곳 클릭하거나 Tab으로 이동 시)
            isbnInput.addEventListener('blur', function() {
                processIsbnAndFetch();
            });
        }

        function fetchBookInfo(isbn) {
            // 커서 모양 변경으로 로딩 표시
            document.body.style.cursor = 'wait';

            const apiUrl = `/bookstore/api/search/?isbn=${isbn}`;
            console.log('API 요청 URL:', apiUrl);

            // API 호출
            fetch(apiUrl)
                .then(response => {
                    console.log('API 응답 상태:', response.status, response.statusText);
                    if (!response.ok) {
                        console.error('API 응답 에러:', response.status);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('API 응답 데이터:', data);
                    document.body.style.cursor = 'default';
                    if (!data.error) {
                        const titleInput = document.getElementById('id_title');
                        const authorInput = document.getElementById('id_author');
                        const publisherInput = document.getElementById('id_publisher');
                        const originalPriceInput = document.getElementById('id_original_price');

                        if (titleInput && !titleInput.value) titleInput.value = data.title;
                        if (authorInput && !authorInput.value) authorInput.value = data.author;
                        if (publisherInput && !publisherInput.value) publisherInput.value = data.publisher;
                        if (originalPriceInput && data.price && data.price !== '0' && !originalPriceInput.value) {
                            originalPriceInput.value = data.price;
                        }
                        console.log('교재 정보 자동 입력 완료');
                        // 제목으로 포커스 이동
                        if (titleInput) titleInput.focus();
                    } else {
                        console.log('API 에러 응답:', data.error);
                        // 에러여도 제목으로 이동
                        const titleInput = document.getElementById('id_title');
                        if (titleInput) titleInput.focus();
                    }
                })
                .catch(error => {
                    document.body.style.cursor = 'default';
                    console.error('API Error:', error);
                    const titleInput = document.getElementById('id_title');
                    if (titleInput) titleInput.focus();
                });
        }

        // 2. [핵심] 구매처 등록 이동 시 데이터 보존 로직
        const addSupplierBtn = document.getElementById('add-supplier-btn');
        if (addSupplierBtn) {
            addSupplierBtn.addEventListener('click', function(e) {
                e.preventDefault();

                const params = new URLSearchParams();
                // 저장할 필드 목록
                const fields = ['created_at', 'isbn', 'title', 'author', 'publisher', 'original_price', 'cost_price', 'price', 'stock', 'memo'];

                fields.forEach(field => {
                    const element = document.getElementById('id_' + field);
                    if (element && element.value) {
                        params.append(field, element.value);
                    }
                });

                // 현재 입력값들을 쿼리 스트링으로 만듦
                const returnUrl = "{% url 'bookstore:book_create' %}?" + params.toString();

                // next 파라미터에 담아서 이동
                const targetUrl = "{% url 'bookstore:supplier_create' %}?next=" + encodeURIComponent(returnUrl);
                window.location.href = targetUrl;
            });
        }
    });
</script>
{% endblock %}
